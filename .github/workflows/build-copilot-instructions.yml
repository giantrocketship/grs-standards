name: Build Copilot Instructions

on:
    push:
        branches:
            - "**"

permissions:
    contents: write

jobs:
    build-copilot-instructions:
        # Avoid infinite loops when this workflow commits changes
        if: github.actor != 'github-actions[bot]'
        runs-on: ubuntu-latest

        steps:
            - name: Check out repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Generate consolidated copilot instructions and coding standards
              run: |
                  set -euo pipefail
                  OUT_COPILOT="copilot-instructions.md"
                  OUT_STANDARDS="CODING-STANDARDS.md"

                  # Shared merged content
                  TMP="/tmp/grs-standards-merged.md"

                  {
                    cat README.md
                    echo
                    echo "---"
                    echo
                    cat sections/code-structure.md
                    echo
                    echo "---"
                    echo
                    cat sections/database.md
                    echo
                    echo "---"
                    echo
                    cat sections/dates.md
                    echo
                    echo "---"
                    echo
                    cat sections/testing.md
                    echo
                    echo "---"
                    echo
                    cat sections/error-handling.md
                  } > "$TMP"

                  {
                    echo "# GRS Copilot Instructions"
                    echo
                    echo "> Auto-generated from grs-standards. Do not edit by hand; update the source markdown instead."
                    echo
                    cat "$TMP"
                  } > "$OUT_COPILOT"

                  {
                    echo "# GRS Coding Standards"
                    echo
                    echo "> Auto-generated from grs-standards. Do not edit by hand; update the source markdown instead."
                    echo
                    cat "$TMP"
                  } > "$OUT_STANDARDS"

            - name: Commit and push if changed
              run: |
                  set -euo pipefail

                  # Check if either file is new or modified
                  if ! git status --porcelain copilot-instructions.md CODING-STANDARDS.md | grep . >/dev/null 2>&1; then
                    echo "copilot-instructions.md and CODING-STANDARDS.md are up to date; nothing to commit."
                    exit 0
                  fi

                  git config user.name "github-actions[bot]"
                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

                  git add copilot-instructions.md CODING-STANDARDS.md
                  git commit -m "chore: update copilot-instructions and CODING-STANDARDS [ci skip]"
                  git push
